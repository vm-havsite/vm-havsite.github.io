<!DOCTYPE html>
<html lang="en">
<head>
    <title>havchat</title>
    <meta charset="UTF-8">
    <meta http-equiv=‚Äùrefresh‚Äù content=‚Äù5‚Ä≥>
    <meta name="viewport" content="width=device-width, initial-scale=1" decription="chat app by havsite">
    <link rel="icon" type="image/x-icon" href="images/logo_og.png">
    <style>
        .main {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            padding: 20px;
        }
        #contacts {
            width: 30%;
            max-width: 40%;
            text-overflow: wrap;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ccc;
        }
        #chatwindow {
            width: 70%;
            min-width: 60%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ccc;
        }
        #messageInput {
            width: 80%;
            float: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: inherit;
            height: max-content;
            box-shadow: 0 0 10px rgba(35, 35, 35, 0.705);
        }
        .un{
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            font-size: 20px;
            color: #100028;
        }
    </style>
</head>
<body>
<div class="main">
<div id="contacts"></div>
<div id="chatwindow">
    <input type="text" id="messageInput" placeholder="Type your message here...">
    <button id="sendButton">Send</button>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.0">
    console.log(window.Appwrite);
    </script>
        <script type="module">
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js';
    import { app, db } from './firebase_auth.js';
    const auth = getAuth(app); // Make sure this line exists
    
    
    const client = new Appwrite.Client()
        .setEndpoint('https://cloud.appwrite.io/v1') // Appwrite endpoint
        .setProject('havsite-user-login-0') // Project ID
    
    const storage = new Appwrite.Storage(client);
    
    
    
            let username = '';
            let currentChat = '';
    
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        username = userData.username;
                        loadContacts();
                    }
                } else {
                    window.location.href = "auth ui.html";
                }
            });
    
            async function loadContacts() {
                const querySnapshot = await getDocs(collection(db, "users"));
                const contactsSelect = document.getElementById("contacts");
    
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    let option = document.createElement("button");
                    option.value = userData.username;
                    option.textContent = userData.username;
                    contactsSelect.appendChild(option);
                });
    
                contactsSelect.addEventListener('change', (e) => {
                    currentChat = e.target.value;
                    listenForMessages();
                });
            }
    
            function listenForMessages() {
                const chatId = getChatId(username, currentChat);
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const q = query(messagesRef, orderBy('timestamp'));
    
                onSnapshot(q, (snapshot) => {
                    const messages = snapshot.docs.map(doc => doc.data());
                    displayMessages(messages);
                });
            }
    
            function displayMessages(messages) {
                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = messages
                    .map(m => {
                        if (m.fileUrl) {
                            const fileExtension = m.fileUrl.split('.').pop().toLowerCase();
                            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
                            if (imageExtensions.includes(fileExtension)) {
                                return `<p class="un"><strong>${m.sender}:</strong> <img src="${m.fileUrl}" alt="Image" style="max-width: 100%; height: auto;"></p>`;
                            } else {
                                return `<p class="un"><strong>${m.sender}:</strong> <a href="${m.fileUrl}" target="_blank">üìÅ File Attachment</a></p>`;
                            }
                        }
                        return `<p><strong>${m.sender}:</strong> ${m.message}</p>`;
                    })
                    .join('');
            }
    
            async function uploadFile(file) {
                try {
                    const response = await storage.createFile('havsite-storage-1', 'unique()', file);
                    return `https://cloud.appwrite.io/v1/storage/buckets/havsite-storage-1/files/${response.$id}/view?project=havsite-user-login-0`;
                } catch (error) {
                    console.error('Upload failed:', error);
                    return '';
                }
            }
    
            document.getElementById('sendButton').addEventListener('click', async () => {
                const messageInput = document.getElementById('messageInput');
                const fileInput = document.getElementById('fileInput');
                const message = messageInput.value;
                const file = fileInput.files[0];
    
                let fileUrl = '';
                if (file) {
                    fileUrl = await uploadFile(file);
                }
    
                if (message || fileUrl) {
                    const chatId = getChatId(username, currentChat);
                    await addDoc(collection(db, `chats/${chatId}/messages`), {
                        sender: username,
                        receiver: currentChat,
                        message: message || '',
                        fileUrl: fileUrl || '',
                        timestamp: new Date()
                    });
                    messageInput.value = '';
                    fileInput.value = '';
                }
            });
    
            function getChatId(user1, user2) {
                return [user1, user2].sort().join('_');
            }
        </script>
</body>
</html>